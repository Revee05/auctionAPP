generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum RoleName {
  SUPER_ADMIN
  ADMIN
  ARTIST
  COLLECTOR
}

enum UserStatus {
  ACTIVE
  SUSPENDED
  PENDING_VERIFICATION
  DEACTIVATED
  BANNED
}

model Role {
  id        Int       @id @default(autoincrement())
  name      RoleName  @unique
  users     UserRole[]
  createdAt DateTime  @default(now())
}

model User {
  id                      Int            @id @default(autoincrement())
  name                    String
  email                   String         @unique
  password                String?
  emailVerified           Boolean        @default(false)
  verificationToken       String?        @unique
  verificationTokenHash   String?        @unique
  verificationTokenExpiry DateTime?
  registrationIp          String?
  verificationIp          String?
  roles                   UserRole[]
  refreshTokens           RefreshToken[]
  status                  UserStatus     @default(ACTIVE)
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  
  @@index([verificationTokenHash])
}

model RefreshToken {
  id         Int       @id @default(autoincrement())
  token      String?   @unique  // Legacy field, will be deprecated
  tokenHash  String?   @unique  // New hashed token field
  userId     Int
  expiresAt  DateTime
  createdAt  DateTime  @default(now())
  lastUsedAt DateTime?
  revoked    Boolean   @default(false)
  deviceInfo String?
  ip         String?
  hashVersion Int      @default(1)
  
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId, revoked, expiresAt])
  @@index([tokenHash])
  @@index([token])
}

model UserRole {
  userId     Int
  roleId     Int
  assignedAt DateTime @default(now())

  user       User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role       Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@id([userId, roleId])
}
